define(["esri/layers/GraphicsLayer","esri/layers/FeatureLayer","esri/symbols/TextSymbol","esri/tasks/support/Query","esri/Graphic","esri/geometry/support/webMercatorUtils","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","require"],function(e,t,s,i,r,l,a,o,u,p,h){var n={type:"simple",symbol:{type:"simple-marker",style:"circle",size:10,color:[255,255,255,.6],outline:{width:1.5,color:"red",style:"solid"}},visualVariables:[{type:"size",field:"point_count",minDataValue:3,maxDataValue:1e3,minSize:{type:"size",valueExpression:"$view.scale",stops:[{value:1128,size:"20px"},{value:591657528,size:"12px"}]},maxSize:{type:"size",valueExpression:"$view.scale",stops:[{value:1128,size:"60px"},{value:288895,size:"50px"},{value:73957191,size:"40px"},{value:591657528,size:"12px"}]}}]},c=[{name:"cluster_id",alias:"Cluster ID in Local Index",type:"oid"},{name:"point_count",alias:"Total Points in Cluster Recorded",type:"long"},{name:"point_count_abbreviated",alias:"Total Points in Cluster (abbreviated)",type:"string"}],d={title:"Cluster Info",content:[{type:"fields",fieldInfos:[{fieldName:"cluster_id",label:"Cluster ID in Local Index",visible:!0},{fieldName:"point_count",label:"Total Points in Cluster",visible:!0},{fieldName:"point_count_abbreviated",label:"Total Points in Cluster (abbreviated)",visible:!0}]}]},y={type:"text",color:"black",haloColor:"blue",haloSize:"40px",text:"",xoffset:0,yoffset:"-4px",font:{size:"12px",family:"sans-serif",weight:"bolder"}};return t.createSubclass({constructor:function(e){for(var t in this.opts=e,this.featureLayerOpts={},this.worker=new Worker(h.toUrl("./ClusterWorker.js")),this.worker.onmessage=o.hitch(this,function(e){e.data.workerReady?this.worker.postMessage({supercluster:h.toUrl("./")+"../node_modules/supercluster/dist/supercluster.js"}):e.data.superclusterReady?(this.clusterWorkerReady=!0,this.view&&this.initClusterLayer()):e.data.indexReady?(this.clusterIndexReady=!0,this.requestClusters(!0)):this.displayClusters(e.data)}),this.opts)"supercluster"!=t&&(this.featureLayerOpts[t]=this.opts[t]);this.opts.url&&delete this.opts.url,this.opts.source&&delete this.opts.source,this.opts.supercluster||(this.opts.supercluster={}),(this.opts.supercluster.initial||this.opts.supercluster.map||this.opts.supercluster.reduce)&&(console.log("Removing initial/map/reduce methods from supercluster options (define in a separate script)."),this.opts.supercluster.initial&&delete this.opts.supercluster.initial,this.opts.supercluster.map&&delete this.opts.supercluster.map,this.opts.supercluster.reduce&&delete this.opts.supercluster.reduce),this.currentFeatures=[],this.currentClusters=[],this.view=null,this.allViews=[],this.clusterFieldNames=u.map(c,function(e){return e.name});var s=this.opts.supercluster.fields||[];return this.opts.fields=c.concat(u.filter(s,o.hitch(this,function(e){return-1==this.clusterFieldNames.indexOf(e.name)}))),this.opts.popupTemplate=this.opts.supercluster.popupTemplate||d,this.opts.labelsVisible=this.opts.supercluster.labelsVisible||!1,this.opts.labelSymbol=this.opts.supercluster.labelSymbol||y,this.opts.labelField=this.opts.supercluster.labelField||"point_count_abbreviated",this.opts.labelFormatter=this.opts.supercluster.labelFormatter||null,this.opts.renderer=this.opts.supercluster.renderer||n,this.opts.geometryType="point",this.opts.spatialReference={wkid:4326},this.opts.objectIdField="cluster_id",this.opts.source=[],this.inherited(arguments)},applyEdits:function(){var e=this.source_layer.applyEdits.apply(this,arguments);return e.when(o.hitch(this,function(){this.loadFeatures()})),e},createLayerView:function(t){return this.view||(this.view=t),this.allViews.push(t),this.opts.labelsVisible&&(this.labelGraphics=new e({graphics:[],popupTemplate:this.popupTemplate}),this.view.map.add(this.labelGraphics)),this.clusterWorkerReady&&this.initClusterLayer(),this.inherited(arguments)},destroyLayerView:function(e){return this.allViews.splice(this.allViews.indexOf(e),1),-1==this.allViews.indexOf(this.view)&&(this.allViews.length>0?this.view=this.allViews[0]:this.view=null),this.inherited(arguments)},initClusterLayer:function(e){this.featureLayerOpts.url&&!this.featureLayerOpts.direct_url?(this.source_layer=new t(this.featureLayerOpts),this.source_layer.load().then(o.hitch(this,function(){this.definitionExpression=this.source_layer.definitionExpression,this.view.watch("stationary",o.hitch(this,this.requestClusters)),this.watch("definitionExpression",function(e,t){this.source_layer.definitionExpression=e,this.loadFeatures()}),this.loadFeatures()}),function(e){console.log("Error: ",e)})):(this.view.watch("stationary",o.hitch(this,this.requestClusters)),this.loadFeatures())},loadFeatures:function(e,t){var s=o.mixin({},this.opts.supercluster);if(s.labelFormatter&&delete s.labelFormatter,s.popupTemplate&&delete s.popupTemplate,s.renderer&&delete s.renderer,s.fields&&delete s.fields,this.clusterIndexReady||this.worker.postMessage({opts:s}),this.featureLayerOpts.source){if(this.currentFeatures.length>0)return;this.worker.postMessage({features:this.featureLayerOpts.source,type:"esri",load:!0})}else if(this.featureLayerOpts.url&&this.featureLayerOpts.direct_url){if(this.currentFeatures.length>0)return;this.worker.postMessage({url:this.featureLayerOpts.url,load:!0,type:this.featureLayerOpts.direct_type||"geojson"})}else{e=e||this.source_layer.definitionExpression||"1=1",0==(t=t||0)&&(this.currentFeatures=[]);var r=u.filter(this.source_layer.outFields,o.hitch(this,function(e){return-1==this.clusterFieldNames.indexOf(e)}));0==r.length&&(r=[this.source_layer.objectIdField]);var l=new i({num:this.source_layer.maxRecordCount||1e3,start:t,where:e,outFields:r,outSpatialReference:{wkid:4326},returnGeometry:!0}),a=o.hitch(this,function(e){this.worker.postMessage({features:e.features.map(f),type:"esri",load:!e.exceededTransferLimit}),e.exceededTransferLimit&&(l.start+=e.features.length,this.source_layer.queryFeatures(l).then(a))});this.source_layer.queryFeatures(l).then(a)}},requestClusters:function(e){if(this.view.popup.visible&&this.view.popup.selectedFeature&&(this.view.popup.selectedFeature.layer!=this&&this.view.popup.selectedFeature.layer!=this.labelGraphics||(this.view.popup.visible=!1)),e&&this.clusterIndexReady&&this.view){var t=parseInt(Math.round(this.view.zoom)),s=l.webMercatorToGeographic(t<5?this.view.map.basemap.baseLayers.items[0].fullExtent:this.view.extent);this.worker.postMessage({bbox:[s.xmin,s.ymin,s.xmax,s.ymax],zoom:t})}},displayClusters:function(e){this.currentClusters=u.map(e,m),this.labelGraphics&&this.labelGraphics.removeAll(),this.source.removeAll(),this.source.addMany(this.currentClusters),this.labelGraphics&&this.labelGraphics.addMany(u.map(u.filter(this.currentClusters,o.hitch(this,function(e){return e.attributes.point_count>0})),o.hitch(this,function(e){return new r({geometry:e.geometry,attributes:e.attributes,symbol:new s(o.mixin({},this.opts.labelSymbol,{text:this.opts.labelFormatter?this.opts.labelFormatter(e.attributes[this.opts.labelField]):e.attributes[this.opts.labelField]}))})})))}});function f(e){return e.toJSON()}function m(e){try{return new r({geometry:{type:"point",longitude:e.geometry.coordinates[0],latitude:e.geometry.coordinates[1]},attributes:e.properties})}catch(e){console.log("Error converting GeoJSON to Graphic:",e)}}});
//# sourceMappingURL=ClusterLayer.js.map