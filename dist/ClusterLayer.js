define(["esri/layers/GraphicsLayer","esri/layers/FeatureLayer","esri/symbols/TextSymbol","esri/layers/support/LabelClass","esri/tasks/support/Query","esri/Graphic","esri/geometry/support/webMercatorUtils","esri/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/Deferred","dojo/on","dojo/has","require"],function(e,t,r,s,o,i,a,l,n,u,p,c,d,f,b){var h=parseFloat(l.version),y=1==f("esri-featurelayer-webgl"),m={type:"simple",symbol:{type:"simple-marker",style:"circle",size:10,color:[255,255,255,.6],outline:{width:1.5,color:"red",style:"solid"}},visualVariables:[{type:"size",field:"point_count",minDataValue:3,maxDataValue:1e3,minSize:{type:"size",valueExpression:"$view.scale",stops:[{value:1128,size:"20px"},{value:591657528,size:"12px"}]},maxSize:{type:"size",valueExpression:"$view.scale",stops:[{value:1128,size:"60px"},{value:288895,size:"50px"},{value:73957191,size:"40px"},{value:591657528,size:"12px"}]}}]},v=[{name:"objectid",alias:"Cluster ID in Local Index",type:"oid"},{name:"cluster_id",alias:"Cluster ID in Local Index",type:"long"},{name:"point_count",alias:"Total Points in Cluster Recorded",type:"long"},{name:"point_count_abbreviated",alias:"Total Points in Cluster (abbreviated)",type:"string"}],w={title:"Cluster Info",content:[{type:"fields",fieldInfos:[{fieldName:"cluster_id",label:"Cluster ID in Local Index",visible:!0},{fieldName:"point_count",label:"Total Points in Cluster",visible:!0},{fieldName:"point_count_abbreviated",label:"Total Points in Cluster (abbreviated)",visible:!0}]}]},_={type:"text",color:"black",haloColor:"blue",haloSize:"40px",text:"",xoffset:0,yoffset:"-4px",font:{size:"12px",family:"sans-serif",weight:"bolder"}},x=[new s({labelExpressionInfo:{expression:"$feature.point_count_abbreviated"},labelPlacement:"center-center",symbol:{type:"text",color:"black",font:{size:9,family:"sans-serif",weight:"normal"}}})];return t.createSubclass({properties:{clusterIndexReady:{},source_definitionExpression:{}},constructor:function(e){var t=this;for(var r in t.opts=e,t.featureLayerOpts={},t.worker=new Worker(b.toUrl("./ClusterWorker.js")),t.worker.onmessage=function(e){e.data.workerReady?t.worker.postMessage({supercluster:b.toUrl("./")+"../node_modules/supercluster/dist/supercluster.js"}):e.data.superclusterReady?(t.clusterWorkerReady=!0,t.view&&t.initClusterLayer()):e.data.indexReady?(t.clusterIndexReady=!0,t.requestClusters(!0)):t.displayClusters(e.data)},t.opts){var s=t.opts[r];"source_url"==r?t.featureLayerOpts.url=s:"source_definitionExpression"==r?t.featureLayerOpts.definitionExpression=s:"source_outFields"==r?t.featureLayerOpts.outFields=s:"supercluster"!=r&&"source"!=r&&"popupTemplate"!=r&&"renderer"!=r&&(t.featureLayerOpts[r]=s)}t.opts.supercluster||(t.opts.supercluster={}),t.currentFeatures=[],t.currentClusters=[],t.view=null,t.allViews=[],t.clusterFieldNames=p.map(v,function(e){return e.name});var i=t.opts.supercluster.fields||[];return t.opts.fields=v.concat(p.filter(i,function(e){return-1==t.clusterFieldNames.indexOf(e.name)})),t.opts.popupTemplate||(t.opts.popupTemplate=w),t.opts.labelsVisible&&4.9<=h&&!y&&(t.opts.labelWithGraphics=!0),t.opts.labelWithGraphics&&(t.opts.labelsVisible=!1),t.opts.labelsVisible&&!t.opts.labelingInfo&&(t.opts.labelingInfo=x),t.opts.labelsVisible&&!t.opts.labelingInfo&&(t.opts.labelingInfo=x),!t.opts.labelsVisible&&!t.opts.labelWithGraphics||t.opts.labelSymbol||(t.opts.labelSymbol=_),!t.opts.labelsVisible&&!t.opts.labelWithGraphics||t.opts.labelField||(t.opts.labelField="point_count_abbreviated"),t.opts.renderer||(t.opts.renderer=m),t.opts.geometryType="point",t.opts.spatialReference={wkid:4326},t.opts.objectIdField="objectid",t.opts.source&&(t.opts.source_features=t.opts.source),t.opts.source=[],t.inherited(arguments)},createLayerView:function(e){return this.view||(this.view=e),this.allViews.push(e),this.opts.labelWithGraphics&&this.enableLabelGraphics(),this.watchView(this.view),this.clusterWorkerReady&&this.initClusterLayer(),this.inherited(arguments)},destroyLayerView:function(e){return this.allViews.splice(this.allViews.indexOf(e),1),-1==this.allViews.indexOf(this.view)&&(0<this.allViews.length?this.view=this.allViews[0]:this.view=null),this.watchView(this.view),this.inherited(arguments)},enableLabelGraphics:function(){this.labelWithGraphics=!0,this.labelGraphics=new e({graphics:[],popupTemplate:this.popupTemplate}),this.view.map.add(this.labelGraphics),y&&(this.labelGraphics.opacity=0)},watchView:function(e){var t=this;t.stationaryWatch&&t.stationaryWatch.remove(),t.scaleWatch&&t.scaleWatch.remove(),e&&(t.stationaryWatch=t.view.watch("stationary",function(e){t.refreshClusters(e)}),t.scaleWatch=t.view.watch("scale",function(){t.labelGraphics&&y&&(t.labelGraphics.opacity=0)}))},initClusterLayer:function(e){var r=this;r.featureLayerOpts.url&&!r.featureLayerOpts.direct_url?(r.source_layer=new t(r.featureLayerOpts),r.source_layer.load().then(function(){r.source_definitionExpression=r.source_layer.definitionExpression,r.watch("source_definitionExpression",function(e,t){r.source_layer.definitionExpression=e,r.loadFeatures()}),r.loadFeatures()},function(e){console.log("Error: ",e)})):r.loadFeatures()},loadFeatures:function(e,t){var r=this,s=u.mixin({},r.opts.supercluster);if(s.fields&&delete s.fields,r.clusterIndexReady||r.worker.postMessage({opts:s}),r.opts.source_features){if(0<r.currentFeatures.length)return;r.worker.postMessage({features:r.opts.source_features,type:"esri",load:!0})}else if(r.opts.source_url&&r.featureLayerOpts.direct_url){if(0<r.currentFeatures.length)return;r.worker.postMessage({url:r.opts.source_url,load:!0,type:r.featureLayerOpts.direct_type||"geojson"})}else{e=e||r.source_layer.definitionExpression||"1=1",0==(t=t||0)&&(r.currentFeatures=[]);var i=p.filter(r.source_layer.outFields,function(e){return-1==r.clusterFieldNames.indexOf(e)});0==i.length&&(i=[r.source_layer.objectIdField]);var a=new o({num:r.source_layer.maxRecordCount||1e3,start:t,where:e,outFields:i,outSpatialReference:{wkid:4326},returnGeometry:!0}),l=function(e){r.worker.postMessage({features:e.features.map(g),type:"esri",load:!e.exceededTransferLimit}),e.exceededTransferLimit&&(a.start+=e.features.length,r.source_layer.queryFeatures(a).then(l))};r.source_layer.queryFeatures(a).then(l)}},requestClusters:function(){var e=this;if(e.clusterIndexReady&&e.view){var t=parseInt(Math.round(e.view.zoom)),r=a.webMercatorToGeographic(t<5?e.view.map.basemap.baseLayers.items[0].fullExtent:e.view.extent);e.worker.postMessage({bbox:[r.xmin,r.ymin,r.xmax,r.ymax],zoom:t})}},refreshClusters:function(e){var t=this;t.view.popup.visible&&t.view.popup.selectedFeature&&(t.view.popup.selectedFeature.layer!=t&&t.view.popup.selectedFeature.layer!=t.labelGraphics||(t.view.popup.visible=!1)),e&&(t.refresh_deferred||t.clearClusters().then(function(){t.refresh_deferred=!1}))},clearClusters:function(){var r=this;function e(){r.source.removeAll(),r.labelsVisible&&!1!==r.labelWithGraphics&&r.enableLabelGraphics(),r.requestClusters()}return r.refresh_deferred=new c,r.labelGraphics&&r.labelGraphics.removeAll(),y&&4.9<=h?r.queryFeatures().then(function(e){var t=p.map(e.features,function(e){return{objectId:e.attributes.objectid}});0<t.length?r.applyEdits({deleteFeatures:t}).then(function(){r.requestClusters()}):r.requestClusters()},function(){e()}):e(),r.refresh_deferred.promise},displayClusters:function(e){var r=this;function t(){r.source.addMany(r.currentClusters),r.addLabelGraphics(),r.refresh_deferred&&r.refresh_deferred.resolve()}r.currentClusters=p.map(e,function(e){var t=function(e){try{return new i({geometry:{type:"point",longitude:e.geometry.coordinates[0],latitude:e.geometry.coordinates[1]},attributes:e.properties})}catch(e){console.log("Error converting GeoJSON to Graphic:",e)}}(e);return t.attributes.point_count_abbreviated&&(t.attributes.point_count_abbreviated=t.attributes.point_count_abbreviated.toString()),r.opts.labelFormatter&&(t.attributes[r.opts.labelField]=r.opts.labelFormatter(t.attributes[r.opts.labelField])||t.attributes[r.opts.labelField]),t}),y&&4.9<=h?r.applyEdits({addFeatures:r.currentClusters}).then(function(e){r.addLabelGraphics(),r.refresh_deferred&&r.refresh_deferred.resolve()},function(){t()}):t()},addLabelGraphics:function(){var t=this;t.labelGraphics&&(t.labelGraphics.addMany(p.map(p.filter(t.currentClusters,function(e){return 0<e.attributes.point_count}),function(e){return new i({geometry:e.geometry,attributes:e.attributes,symbol:new r(u.mixin({},t.opts.labelSymbol,{text:e.attributes[t.opts.labelField]}))})})),y&&setTimeout(function(){t.labelGraphics.opacity=1},t.has_loaded?300:500),t.has_loaded=!0)}});function g(e){return e.toJSON()}});
//# sourceMappingURL=ClusterLayer.js.map