!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).supercluster=t()}}(function(){return function t(e,o,r){function n(s,a){if(!o[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var c=o[s]={exports:{}};e[s][0].call(c.exports,function(t){var o=e[s][1][t];return n(o||t)},c,c.exports,t,e,o,r)}return o[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)n(r[s]);return n}({1:[function(t,e,o){"use strict";var r=t("kdbush");function n(t){return new i(t)}function i(t){this.options=c(Object.create(this.options),t),this.trees=new Array(this.options.maxZoom+1)}function s(t){return{type:"Feature",properties:a(t),geometry:{type:"Point",coordinates:[(r=t.x,360*(r-.5)),(e=t.y,o=(180-360*e)*Math.PI/180,360*Math.atan(Math.exp(o))/Math.PI-90)]}};var e,o,r}function a(t){var e=t.numPoints,o=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return c(c({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:o})}function u(t){return t/360+.5}function p(t){var e=Math.sin(t*Math.PI/180),o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:o>1?1:o}function c(t,e){for(var o in e)t[o]=e[o];return t}function f(t){return t.x}function d(t){return t.y}e.exports=n,e.exports.default=n,i.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,reduce:null,initial:function(){return{}},map:function(t){return t}},load:function(t){var e=this.options.log;e&&console.time("total time");var o="prepare "+t.length+" points";e&&console.time(o),this.points=t;for(var n,i,s,a=[],c=0;c<t.length;c++)t[c].geometry&&a.push((n=t[c],i=c,void 0,{x:u((s=n.geometry.coordinates)[0]),y:p(s[1]),zoom:1/0,id:i,parentId:-1}));this.trees[this.options.maxZoom+1]=r(a,f,d,this.options.nodeSize,Float32Array),e&&console.timeEnd(o);for(var h=this.options.maxZoom;h>=this.options.minZoom;h--){var l=+Date.now();a=this._cluster(a,h),this.trees[h]=r(a,f,d,this.options.nodeSize,Float32Array),e&&console.log("z%d: %d clusters in %dms",h,a.length,+Date.now()-l)}return e&&console.timeEnd("total time"),this},getClusters:function(t,e){if(t[0]>t[2]){var o=this.getClusters([t[0],t[1],180,t[3]],e),r=this.getClusters([-180,t[1],t[2],t[3]],e);return o.concat(r)}for(var n=this.trees[this._limitZoom(e)],i=n.range(u(t[0]),p(t[3]),u(t[2]),p(t[1])),a=[],c=0;c<i.length;c++){var f=n.points[i[c]];a.push(f.numPoints?s(f):this.points[f.id])}return a},getChildren:function(t){var e=t>>5,o=t%32,r="No cluster with the specified id.",n=this.trees[o];if(!n)throw new Error(r);var i=n.points[e];if(!i)throw new Error(r);for(var a=this.options.radius/(this.options.extent*Math.pow(2,o-1)),u=n.within(i.x,i.y,a),p=[],c=0;c<u.length;c++){var f=n.points[u[c]];f.parentId===t&&p.push(f.numPoints?s(f):this.points[f.id])}if(0===p.length)throw new Error(r);return p},getLeaves:function(t,e,o){e=e||10,o=o||0;var r=[];return this._appendLeaves(r,t,e,o,0),r},getTile:function(t,e,o){var r=this.trees[this._limitZoom(t)],n=Math.pow(2,t),i=this.options.extent,s=this.options.radius/i,a=(o-s)/n,u=(o+1+s)/n,p={features:[]};return this._addTileFeatures(r.range((e-s)/n,a,(e+1+s)/n,u),r.points,e,o,n,p),0===e&&this._addTileFeatures(r.range(1-s/n,a,1,u),r.points,n,o,n,p),e===n-1&&this._addTileFeatures(r.range(0,a,s/n,u),r.points,-1,o,n,p),p.features.length?p:null},getClusterExpansionZoom:function(t){for(var e=t%32-1;e<this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e},_appendLeaves:function(t,e,o,r,n){for(var i=this.getChildren(e),s=0;s<i.length;s++){var a=i[s].properties;if(a&&a.cluster?n+a.point_count<=r?n+=a.point_count:n=this._appendLeaves(t,a.cluster_id,o,r,n):n<r?n++:t.push(i[s]),t.length===o)break}return n},_addTileFeatures:function(t,e,o,r,n,i){for(var s=0;s<t.length;s++){var u=e[t[s]];i.features.push({type:1,geometry:[[Math.round(this.options.extent*(u.x*n-o)),Math.round(this.options.extent*(u.y*n-r))]],tags:u.numPoints?a(u):this.points[u.id].properties})}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,e){for(var o=[],r=this.options.radius/(this.options.extent*Math.pow(2,e)),n=0;n<t.length;n++){var i=t[n];if(!(i.zoom<=e)){i.zoom=e;var s=this.trees[e+1],a=s.within(i.x,i.y,r),u=i.numPoints||1,p=i.x*u,c=i.y*u,f=null;this.options.reduce&&(f=this.options.initial(),this._accumulate(f,i));for(var d=(n<<5)+(e+1),h=0;h<a.length;h++){var l=s.points[a[h]];if(!(l.zoom<=e)){l.zoom=e;var m=l.numPoints||1;p+=l.x*m,c+=l.y*m,u+=m,l.parentId=d,this.options.reduce&&this._accumulate(f,l)}}1===u?o.push(i):(i.parentId=d,o.push({x:p/u,y:c/u,zoom:1/0,id:d,parentId:-1,numPoints:u,properties:f}))}}return o},_accumulate:function(t,e){var o=e.numPoints?e.properties:this.options.map(this.points[e.id].properties);this.options.reduce(t,o)}}},{kdbush:2}],2:[function(t,e,o){"use strict";var r=t("./sort"),n=t("./range"),i=t("./within");function s(t,e,o,n,i){e=e||a,o=o||u,i=i||Array,this.nodeSize=n||64,this.points=t,this.ids=new i(t.length),this.coords=new i(2*t.length);for(var s=0;s<t.length;s++)this.ids[s]=s,this.coords[2*s]=e(t[s]),this.coords[2*s+1]=o(t[s]);r(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function a(t){return t[0]}function u(t){return t[1]}e.exports=function(t,e,o,r,n){return new s(t,e,o,r,n)},s.prototype={range:function(t,e,o,r){return n(this.ids,this.coords,t,e,o,r,this.nodeSize)},within:function(t,e,o){return i(this.ids,this.coords,t,e,o,this.nodeSize)}}},{"./range":3,"./sort":4,"./within":5}],3:[function(t,e,o){"use strict";e.exports=function(t,e,o,r,n,i,s){var a,u,p=[0,t.length-1,0],c=[];for(;p.length;){var f=p.pop(),d=p.pop(),h=p.pop();if(d-h<=s)for(var l=h;l<=d;l++)a=e[2*l],u=e[2*l+1],a>=o&&a<=n&&u>=r&&u<=i&&c.push(t[l]);else{var m=Math.floor((h+d)/2);a=e[2*m],u=e[2*m+1],a>=o&&a<=n&&u>=r&&u<=i&&c.push(t[m]);var g=(f+1)%2;(0===f?o<=a:r<=u)&&(p.push(h),p.push(m-1),p.push(g)),(0===f?n>=a:i>=u)&&(p.push(m+1),p.push(d),p.push(g))}}return c}},{}],4:[function(t,e,o){"use strict";function r(t,e,o,r){n(t,o,r),n(e,2*o,2*r),n(e,2*o+1,2*r+1)}function n(t,e,o){var r=t[e];t[e]=t[o],t[o]=r}e.exports=function t(e,o,n,i,s,a){if(s-i<=n)return;var u=Math.floor((i+s)/2);!function t(e,o,n,i,s,a){for(;s>i;){if(s-i>600){var u=s-i+1,p=n-i+1,c=Math.log(u),f=.5*Math.exp(2*c/3),d=.5*Math.sqrt(c*f*(u-f)/u)*(p-u/2<0?-1:1),h=Math.max(i,Math.floor(n-p*f/u+d)),l=Math.min(s,Math.floor(n+(u-p)*f/u+d));t(e,o,n,h,l,a)}var m=o[2*n+a],g=i,v=s;for(r(e,o,i,n),o[2*s+a]>m&&r(e,o,i,s);g<v;){for(r(e,o,g,v),g++,v--;o[2*g+a]<m;)g++;for(;o[2*v+a]>m;)v--}o[2*i+a]===m?r(e,o,i,v):r(e,o,++v,s),v<=n&&(i=v+1),n<=v&&(s=v-1)}}(e,o,u,i,s,a%2);t(e,o,n,i,u-1,a+1);t(e,o,n,u+1,s,a+1)}},{}],5:[function(t,e,o){"use strict";function r(t,e,o,r){var n=t-o,i=e-r;return n*n+i*i}e.exports=function(t,e,o,n,i,s){var a=[0,t.length-1,0],u=[],p=i*i;for(;a.length;){var c=a.pop(),f=a.pop(),d=a.pop();if(f-d<=s)for(var h=d;h<=f;h++)r(e[2*h],e[2*h+1],o,n)<=p&&u.push(t[h]);else{var l=Math.floor((d+f)/2),m=e[2*l],g=e[2*l+1];r(m,g,o,n)<=p&&u.push(t[l]);var v=(c+1)%2;(0===c?o-i<=m:n-i<=g)&&(a.push(d),a.push(l-1),a.push(v)),(0===c?o+i>=m:n+i>=g)&&(a.push(l+1),a.push(f),a.push(v))}}return u}},{}]},{},[1])(1)});"use strict";var index,features=[],defaultopts={log:!1,radius:60,extent:256,maxZoom:23,minZoom:0,nodeSize:64,initial:function(t){return{}},map:function(t){return t.point_count=1,t.point_count_abbreviated="1",t},reduce:function(t,e){}};function loadFeatures(){index&&(index.load(features),postMessage({indexReady:!0}))}function addFeatures(t,e){self.features="esri"==e?self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}).map(esriToGeoJSON)):"coords"==e?self.features.concat(t.filter(function(t){return validGeom(t,e)}).map(coordToGeoJSON)):self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}))}function validGeom(t,e){return!!t&&("coords"==e?t.length>=2&&t[0]&&t[1]:"esri"==e?t.geometry&&t.geometry.x&&t.geometry.y:t&&t.geometry&&t.geometry.coordinates&&t.geometry.coordinates.length>=2&&t.geometry.coordinates[0]&&t.geometry.coordinates[1])}function esriToGeoJSON(t){try{var e={type:"Feature",geometry:{type:"Point",coordinates:[t.geometry.x,t.geometry.y]},properties:t.attributes};return e.properties.point_count=1,e.properties.point_count_abbreviated="1",e}catch(e){console.log("Error converting feature to GeoJSON:",t,e)}}function coordToGeoJSON(t,e){try{return{type:"Feature",geometry:{type:"Point",coordinates:t},properties:{objectid:e+1,point_count:1,point_count_abbreviated:"1"}}}catch(t){console.log("Error converting feature to GeoJSON:",feature,t)}}function getJSON(t,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="json",o.setRequestHeader("Accept","application/json"),o.onload=function(){4===o.readyState&&o.status>=200&&o.status<300&&o.response&&e(o.response)},o.send()}self.onmessage=function(t){if(t.data.supercluster)importScripts(t.data.supercluster),postMessage({superclusterReady:!0});else if(t.data&&t.data.bbox&&t.data.zoom)postMessage(self.index.getClusters(t.data.bbox,t.data.zoom));else if(t.data.opts){var e={};for(var o in defaultopts)e[o]=defaultopts[o];for(var o in t.data.opts)e[o]=t.data.opts[o];e.functions&&(importScripts(e.functions),functions.initial&&(e.initial=functions.initial),functions.map&&(e.map=functions.map),functions.reduce&&(e.reduce=functions.reduce)),index=supercluster(e)}else t.data.clear?(features=[],loadFeatures()):t.data.features?(addFeatures(t.data.features,t.data.type),t.data.load&&loadFeatures()):t.data.url&&getJSON(t.data.url,function(e){addFeatures(e,t.data.type||"geojson"),loadFeatures()})},self.supercluster?postMessage({superclusterReady:!0}):postMessage({workerReady:!0});
//# sourceMappingURL=ClusterWorker.js.map