!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.supercluster=e()}(this,function(){"use strict";function a(t,e,o,n,r,i){if(!(r-n<=o)){var s=Math.floor((n+r)/2);!function t(e,o,n,r,i,s){for(;r<i;){if(600<i-r){var a=i-r+1,u=n-r+1,p=Math.log(a),h=.5*Math.exp(2*p/3),d=.5*Math.sqrt(p*h*(a-h)/a)*(u-a/2<0?-1:1),c=Math.max(r,Math.floor(n-u*h/a+d)),f=Math.min(i,Math.floor(n+(a-u)*h/a+d));t(e,o,n,c,f,s)}var l=o[2*n+s],m=r,g=i;for(v(e,o,r,n),o[2*i+s]>l&&v(e,o,r,i);m<g;){for(v(e,o,m,g),m++,g--;o[2*m+s]<l;)m++;for(;o[2*g+s]>l;)g--}o[2*r+s]===l?v(e,o,r,g):v(e,o,++g,i),g<=n&&(r=g+1),n<=g&&(i=g-1)}}(t,e,s,n,r,i%2),a(t,e,o,n,s-1,i+1),a(t,e,o,s+1,r,i+1)}}function v(t,e,o,n){r(t,o,n),r(e,2*o,2*n),r(e,2*o+1,2*n+1)}function r(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}function y(t,e,o,n){var r=t-o,i=e-n;return r*r+i*i}function h(t,e,o,n,r){return new i(t,e,o,n,r)}function i(t,e,o,n,r){e=e||s,o=o||u,r=r||Array,this.nodeSize=n||64,this.points=t,this.ids=new r(t.length),this.coords=new r(2*t.length);for(var i=0;i<t.length;i++)this.ids[i]=i,this.coords[2*i]=e(t[i]),this.coords[2*i+1]=o(t[i]);a(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function s(t){return t[0]}function u(t){return t[1]}function e(t){this.options=n(Object.create(this.options),t),this.trees=new Array(this.options.maxZoom+1)}function f(t){return{type:"Feature",id:t.id,properties:d(t),geometry:{type:"Point",coordinates:[(n=t.x,360*(n-.5)),(e=t.y,o=(180-360*e)*Math.PI/180,360*Math.atan(Math.exp(o))/Math.PI-90)]}};var e,o,n}function d(t){var e=t.numPoints,o=1e4<=e?Math.round(e/1e3)+"k":1e3<=e?Math.round(e/100)/10+"k":e;return n(n({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:o})}function l(t){return t/360+.5}function m(t){var e=Math.sin(t*Math.PI/180),o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:1<o?1:o}function n(t,e){for(var o in e)t[o]=e[o];return t}function c(t){return t.x}function g(t){return t.y}return e.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(i.prototype={range:function(t,e,o,n){return function(t,e,o,n,r,i,s){for(var a,u,p=[0,t.length-1,0],h=[];p.length;){var d=p.pop(),c=p.pop(),f=p.pop();if(c-f<=s)for(var l=f;l<=c;l++)a=e[2*l],u=e[2*l+1],o<=a&&a<=r&&n<=u&&u<=i&&h.push(t[l]);else{var m=Math.floor((f+c)/2);a=e[2*m],u=e[2*m+1],o<=a&&a<=r&&n<=u&&u<=i&&h.push(t[m]);var g=(d+1)%2;(0===d?o<=a:n<=u)&&(p.push(f),p.push(m-1),p.push(g)),(0===d?a<=r:u<=i)&&(p.push(m+1),p.push(c),p.push(g))}}return h}(this.ids,this.coords,t,e,o,n,this.nodeSize)},within:function(t,e,o){return function(t,e,o,n,r,i){for(var s=[0,t.length-1,0],a=[],u=r*r;s.length;){var p=s.pop(),h=s.pop(),d=s.pop();if(h-d<=i)for(var c=d;c<=h;c++)y(e[2*c],e[2*c+1],o,n)<=u&&a.push(t[c]);else{var f=Math.floor((d+h)/2),l=e[2*f],m=e[2*f+1];y(l,m,o,n)<=u&&a.push(t[f]);var g=(p+1)%2;(0===p?o-r<=l:n-r<=m)&&(s.push(d),s.push(f-1),s.push(g)),(0===p?l<=o+r:m<=n+r)&&(s.push(f+1),s.push(h),s.push(g))}}return a}(this.ids,this.coords,t,e,o,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(t){return t}},load:function(t){var e=this.options.log;e&&console.time("total time");var o="prepare "+t.length+" points";e&&console.time(o),this.points=t;for(var n,r,i,s=[],a=0;a<t.length;a++)t[a].geometry&&s.push((n=t[a],r=a,void 0,{x:l((i=n.geometry.coordinates)[0]),y:m(i[1]),zoom:1/0,index:r,parentId:-1}));this.trees[this.options.maxZoom+1]=h(s,c,g,this.options.nodeSize,Float32Array),e&&console.timeEnd(o);for(var u=this.options.maxZoom;u>=this.options.minZoom;u--){var p=+Date.now();s=this._cluster(s,u),this.trees[u]=h(s,c,g,this.options.nodeSize,Float32Array),e&&console.log("z%d: %d clusters in %dms",u,s.length,+Date.now()-p)}return e&&console.timeEnd("total time"),this},getClusters:function(t,e){var o=((t[0]+180)%360+360)%360-180,n=Math.max(-90,Math.min(90,t[1])),r=180===t[2]?180:((t[2]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,t[3]));if(360<=t[2]-t[0])o=-180,r=180;else if(r<o){var s=this.getClusters([o,n,180,i],e),a=this.getClusters([-180,n,r,i],e);return s.concat(a)}for(var u=this.trees[this._limitZoom(e)],p=u.range(l(o),m(i),l(r),m(n)),h=[],d=0;d<p.length;d++){var c=u.points[p[d]];h.push(c.numPoints?f(c):this.points[c.index])}return h},getChildren:function(t){var e=t>>5,o=t%32,n="No cluster with the specified id.",r=this.trees[o];if(!r)throw new Error(n);var i=r.points[e];if(!i)throw new Error(n);for(var s=this.options.radius/(this.options.extent*Math.pow(2,o-1)),a=r.within(i.x,i.y,s),u=[],p=0;p<a.length;p++){var h=r.points[a[p]];h.parentId===t&&u.push(h.numPoints?f(h):this.points[h.index])}if(0===u.length)throw new Error(n);return u},getLeaves:function(t,e,o){e=e||10,o=o||0;var n=[];return this._appendLeaves(n,t,e,o,0),n},getTile:function(t,e,o){var n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),i=this.options.extent,s=this.options.radius/i,a=(o-s)/r,u=(o+1+s)/r,p={features:[]};return this._addTileFeatures(n.range((e-s)/r,a,(e+1+s)/r,u),n.points,e,o,r,p),0===e&&this._addTileFeatures(n.range(1-s/r,a,1,u),n.points,r,o,r,p),e===r-1&&this._addTileFeatures(n.range(0,a,s/r,u),n.points,-1,o,r,p),p.features.length?p:null},getClusterExpansionZoom:function(t){for(var e=t%32-1;e<this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e},_appendLeaves:function(t,e,o,n,r){for(var i=this.getChildren(e),s=0;s<i.length;s++){var a=i[s].properties;if(a&&a.cluster?r+a.point_count<=n?r+=a.point_count:r=this._appendLeaves(t,a.cluster_id,o,n,r):r<n?r++:t.push(i[s]),t.length===o)break}return r},_addTileFeatures:function(t,e,o,n,r,i){for(var s=0;s<t.length;s++){var a=e[t[s]],u={type:1,geometry:[[Math.round(this.options.extent*(a.x*r-o)),Math.round(this.options.extent*(a.y*r-n))]],tags:a.numPoints?d(a):this.points[a.index].properties},p=a.numPoints?a.id:this.points[a.index].id;void 0!==p&&(u.id=p),i.features.push(u)}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,e){for(var o=[],n=this.options.radius/(this.options.extent*Math.pow(2,e)),r=0;r<t.length;r++){var i=t[r];if(!(i.zoom<=e)){i.zoom=e;var s=this.trees[e+1],a=s.within(i.x,i.y,n),u=i.numPoints||1,p=i.x*u,h=i.y*u,d=null;this.options.reduce&&(d=this.options.initial(),this._accumulate(d,i));for(var c=(r<<5)+(e+1),f=0;f<a.length;f++){var l=s.points[a[f]];if(!(l.zoom<=e)){l.zoom=e;var m=l.numPoints||1;p+=l.x*m,h+=l.y*m,u+=m,l.parentId=c,this.options.reduce&&this._accumulate(d,l)}}1===u?o.push(i):(i.parentId=c,o.push({x:p/u,y:h/u,zoom:1/0,id:c,parentId:-1,numPoints:u,properties:d}))}}return o},_accumulate:function(t,e){var o=e.numPoints?e.properties:this.options.map(this.points[e.index].properties);this.options.reduce(t,o)}},function(t){return new e(t)}});"use strict";var index,features=[],defaultopts={log:!1,radius:60,extent:256,maxZoom:23,minZoom:0,nodeSize:64,initial:function(t){return{}},map:function(t){return t.point_count=1,t.point_count_abbreviated="1",t},reduce:function(t,e){}};function loadFeatures(){index&&(index.load(features),postMessage({indexReady:!0}))}function addFeatures(t,e){self.features="esri"==e?self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}).map(esriToGeoJSON)):"coords"==e?self.features.concat(t.filter(function(t){return validGeom(t,e)}).map(coordToGeoJSON)):self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}))}function validGeom(t,e){return!!t&&("coords"==e?2<=t.length&&t[0]&&t[1]:"esri"==e?t.geometry&&t.geometry.x&&t.geometry.y:t&&t.geometry&&t.geometry.coordinates&&2<=t.geometry.coordinates.length&&t.geometry.coordinates[0]&&t.geometry.coordinates[1])}function esriToGeoJSON(e){try{var t={type:"Feature",geometry:{type:"Point",coordinates:[e.geometry.x,e.geometry.y]},properties:e.attributes};return t.properties.point_count=1,t.properties.point_count_abbreviated="1",t}catch(t){console.log("Error converting feature to GeoJSON:",e,t)}}function coordToGeoJSON(t,e){try{return{type:"Feature",geometry:{type:"Point",coordinates:t},properties:{objectid:e+1,point_count:1,point_count_abbreviated:"1"}}}catch(t){console.log("Error converting feature to GeoJSON:",feature,t)}}function getJSON(t,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="json",o.setRequestHeader("Accept","application/json"),o.onload=function(){4===o.readyState&&200<=o.status&&o.status<300&&o.response&&e(o.response)},o.send()}self.onmessage=function(e){if(e.data.supercluster)importScripts(e.data.supercluster),postMessage({superclusterReady:!0});else if(e.data&&e.data.bbox&&e.data.zoom)postMessage(self.index.getClusters(e.data.bbox,e.data.zoom));else if(e.data.opts){var t={};for(var o in defaultopts)t[o]=defaultopts[o];for(var o in e.data.opts)t[o]=e.data.opts[o];t.functions&&(importScripts(t.functions),functions.initial&&(t.initial=functions.initial),functions.map&&(t.map=functions.map),functions.reduce&&(t.reduce=functions.reduce)),index=supercluster(t)}else e.data.clear?(features=[],loadFeatures()):e.data.features?(addFeatures(e.data.features,e.data.type),e.data.load&&loadFeatures()):e.data.url&&getJSON(e.data.url,function(t){addFeatures(t,e.data.type||"geojson"),loadFeatures()})},self.supercluster?postMessage({superclusterReady:!0}):postMessage({workerReady:!0});
//# sourceMappingURL=ClusterWorker.js.map