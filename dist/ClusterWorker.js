var index;!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).supercluster=t()}}(function(){return function t(e,o,n){function r(s,a){if(!o[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var h=o[s]={exports:{}};e[s][0].call(h.exports,function(t){var o=e[s][1][t];return r(o||t)},h,h.exports,t,e,o,n)}return o[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(t,e,o){"use strict";var n=t("kdbush");function r(t){return new i(t)}function i(t){this.options=h(Object.create(this.options),t),this.trees=new Array(this.options.maxZoom+1)}function s(t){return{type:"Feature",properties:a(t),geometry:{type:"Point",coordinates:[(n=t.x,360*(n-.5)),(e=t.y,o=(180-360*e)*Math.PI/180,360*Math.atan(Math.exp(o))/Math.PI-90)]}};var e,o,n}function a(t){var e=t.numPoints,o=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return h(h({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:o})}function u(t){return t/360+.5}function p(t){var e=Math.sin(t*Math.PI/180),o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:o>1?1:o}function h(t,e){for(var o in e)t[o]=e[o];return t}function f(t){return t.x}function c(t){return t.y}e.exports=r,e.exports.default=r,i.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,reduce:null,initial:function(){return{}},map:function(t){return t}},load:function(t){var e=this.options.log;e&&console.time("total time");var o="prepare "+t.length+" points";e&&console.time(o),this.points=t;for(var r,i,s,a=[],h=0;h<t.length;h++)t[h].geometry&&a.push((r=t[h],i=h,void 0,{x:u((s=r.geometry.coordinates)[0]),y:p(s[1]),zoom:1/0,id:i,parentId:-1}));this.trees[this.options.maxZoom+1]=n(a,f,c,this.options.nodeSize,Float32Array),e&&console.timeEnd(o);for(var d=this.options.maxZoom;d>=this.options.minZoom;d--){var l=+Date.now();a=this._cluster(a,d),this.trees[d]=n(a,f,c,this.options.nodeSize,Float32Array),e&&console.log("z%d: %d clusters in %dms",d,a.length,+Date.now()-l)}return e&&console.timeEnd("total time"),this},getClusters:function(t,e){if(t[0]>t[2]){var o=this.getClusters([t[0],t[1],180,t[3]],e),n=this.getClusters([-180,t[1],t[2],t[3]],e);return o.concat(n)}for(var r=this.trees[this._limitZoom(e)],i=r.range(u(t[0]),p(t[3]),u(t[2]),p(t[1])),a=[],h=0;h<i.length;h++){var f=r.points[i[h]];a.push(f.numPoints?s(f):this.points[f.id])}return a},getChildren:function(t){var e=t>>5,o=t%32,n="No cluster with the specified id.",r=this.trees[o];if(!r)throw new Error(n);var i=r.points[e];if(!i)throw new Error(n);for(var a=this.options.radius/(this.options.extent*Math.pow(2,o-1)),u=r.within(i.x,i.y,a),p=[],h=0;h<u.length;h++){var f=r.points[u[h]];f.parentId===t&&p.push(f.numPoints?s(f):this.points[f.id])}if(0===p.length)throw new Error(n);return p},getLeaves:function(t,e,o){e=e||10,o=o||0;var n=[];return this._appendLeaves(n,t,e,o,0),n},getTile:function(t,e,o){var n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),i=this.options.extent,s=this.options.radius/i,a=(o-s)/r,u=(o+1+s)/r,p={features:[]};return this._addTileFeatures(n.range((e-s)/r,a,(e+1+s)/r,u),n.points,e,o,r,p),0===e&&this._addTileFeatures(n.range(1-s/r,a,1,u),n.points,r,o,r,p),e===r-1&&this._addTileFeatures(n.range(0,a,s/r,u),n.points,-1,o,r,p),p.features.length?p:null},getClusterExpansionZoom:function(t){for(var e=t%32-1;e<this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e},_appendLeaves:function(t,e,o,n,r){for(var i=this.getChildren(e),s=0;s<i.length;s++){var a=i[s].properties;if(a&&a.cluster?r+a.point_count<=n?r+=a.point_count:r=this._appendLeaves(t,a.cluster_id,o,n,r):r<n?r++:t.push(i[s]),t.length===o)break}return r},_addTileFeatures:function(t,e,o,n,r,i){for(var s=0;s<t.length;s++){var u=e[t[s]];i.features.push({type:1,geometry:[[Math.round(this.options.extent*(u.x*r-o)),Math.round(this.options.extent*(u.y*r-n))]],tags:u.numPoints?a(u):this.points[u.id].properties})}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,e){for(var o=[],n=this.options.radius/(this.options.extent*Math.pow(2,e)),r=0;r<t.length;r++){var i=t[r];if(!(i.zoom<=e)){i.zoom=e;var s=this.trees[e+1],a=s.within(i.x,i.y,n),u=i.numPoints||1,p=i.x*u,h=i.y*u,f=null;this.options.reduce&&(f=this.options.initial(),this._accumulate(f,i));for(var c=(r<<5)+(e+1),d=0;d<a.length;d++){var l=s.points[a[d]];if(!(l.zoom<=e)){l.zoom=e;var m=l.numPoints||1;p+=l.x*m,h+=l.y*m,u+=m,l.parentId=c,this.options.reduce&&this._accumulate(f,l)}}1===u?o.push(i):(i.parentId=c,o.push({x:p/u,y:h/u,zoom:1/0,id:c,parentId:-1,numPoints:u,properties:f}))}}return o},_accumulate:function(t,e){var o=e.numPoints?e.properties:this.options.map(this.points[e.id].properties);this.options.reduce(t,o)}}},{kdbush:2}],2:[function(t,e,o){"use strict";var n=t("./sort"),r=t("./range"),i=t("./within");function s(t,e,o,r,i){e=e||a,o=o||u,i=i||Array,this.nodeSize=r||64,this.points=t,this.ids=new i(t.length),this.coords=new i(2*t.length);for(var s=0;s<t.length;s++)this.ids[s]=s,this.coords[2*s]=e(t[s]),this.coords[2*s+1]=o(t[s]);n(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function a(t){return t[0]}function u(t){return t[1]}e.exports=function(t,e,o,n,r){return new s(t,e,o,n,r)},s.prototype={range:function(t,e,o,n){return r(this.ids,this.coords,t,e,o,n,this.nodeSize)},within:function(t,e,o){return i(this.ids,this.coords,t,e,o,this.nodeSize)}}},{"./range":3,"./sort":4,"./within":5}],3:[function(t,e,o){"use strict";e.exports=function(t,e,o,n,r,i,s){var a,u,p=[0,t.length-1,0],h=[];for(;p.length;){var f=p.pop(),c=p.pop(),d=p.pop();if(c-d<=s)for(var l=d;l<=c;l++)a=e[2*l],u=e[2*l+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[l]);else{var m=Math.floor((d+c)/2);a=e[2*m],u=e[2*m+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[m]);var v=(f+1)%2;(0===f?o<=a:n<=u)&&(p.push(d),p.push(m-1),p.push(v)),(0===f?r>=a:i>=u)&&(p.push(m+1),p.push(c),p.push(v))}}return h}},{}],4:[function(t,e,o){"use strict";function n(t,e,o,n){r(t,o,n),r(e,2*o,2*n),r(e,2*o+1,2*n+1)}function r(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}e.exports=function t(e,o,r,i,s,a){if(s-i<=r)return;var u=Math.floor((i+s)/2);!function t(e,o,r,i,s,a){for(;s>i;){if(s-i>600){var u=s-i+1,p=r-i+1,h=Math.log(u),f=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*f*(u-f)/u)*(p-u/2<0?-1:1),d=Math.max(i,Math.floor(r-p*f/u+c)),l=Math.min(s,Math.floor(r+(u-p)*f/u+c));t(e,o,r,d,l,a)}var m=o[2*r+a],v=i,g=s;for(n(e,o,i,r),o[2*s+a]>m&&n(e,o,i,s);v<g;){for(n(e,o,v,g),v++,g--;o[2*v+a]<m;)v++;for(;o[2*g+a]>m;)g--}o[2*i+a]===m?n(e,o,i,g):n(e,o,++g,s),g<=r&&(i=g+1),r<=g&&(s=g-1)}}(e,o,u,i,s,a%2);t(e,o,r,i,u-1,a+1);t(e,o,r,u+1,s,a+1)}},{}],5:[function(t,e,o){"use strict";function n(t,e,o,n){var r=t-o,i=e-n;return r*r+i*i}e.exports=function(t,e,o,r,i,s){var a=[0,t.length-1,0],u=[],p=i*i;for(;a.length;){var h=a.pop(),f=a.pop(),c=a.pop();if(f-c<=s)for(var d=c;d<=f;d++)n(e[2*d],e[2*d+1],o,r)<=p&&u.push(t[d]);else{var l=Math.floor((c+f)/2),m=e[2*l],v=e[2*l+1];n(m,v,o,r)<=p&&u.push(t[l]);var g=(h+1)%2;(0===h?o-i<=m:r-i<=v)&&(a.push(c),a.push(l-1),a.push(g)),(0===h?o+i>=m:r+i>=v)&&(a.push(l+1),a.push(f),a.push(g))}}return u}},{}]},{},[1])(1)}),function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).supercluster=t()}}(function(){return function t(e,o,n){function r(s,a){if(!o[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var h=o[s]={exports:{}};e[s][0].call(h.exports,function(t){var o=e[s][1][t];return r(o||t)},h,h.exports,t,e,o,n)}return o[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(t,e,o){"use strict";var n=t("kdbush");function r(t){return new i(t)}function i(t){this.options=h(Object.create(this.options),t),this.trees=new Array(this.options.maxZoom+1)}function s(t){return{type:"Feature",properties:a(t),geometry:{type:"Point",coordinates:[(n=t.x,360*(n-.5)),(e=t.y,o=(180-360*e)*Math.PI/180,360*Math.atan(Math.exp(o))/Math.PI-90)]}};var e,o,n}function a(t){var e=t.numPoints,o=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return h(h({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:o})}function u(t){return t/360+.5}function p(t){var e=Math.sin(t*Math.PI/180),o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:o>1?1:o}function h(t,e){for(var o in e)t[o]=e[o];return t}function f(t){return t.x}function c(t){return t.y}e.exports=r,e.exports.default=r,i.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,reduce:null,initial:function(){return{}},map:function(t){return t}},load:function(t){var e=this.options.log;e&&console.time("total time");var o="prepare "+t.length+" points";e&&console.time(o),this.points=t;for(var r,i,s,a=[],h=0;h<t.length;h++)t[h].geometry&&a.push((r=t[h],i=h,void 0,{x:u((s=r.geometry.coordinates)[0]),y:p(s[1]),zoom:1/0,id:i,parentId:-1}));this.trees[this.options.maxZoom+1]=n(a,f,c,this.options.nodeSize,Float32Array),e&&console.timeEnd(o);for(var d=this.options.maxZoom;d>=this.options.minZoom;d--){var l=+Date.now();a=this._cluster(a,d),this.trees[d]=n(a,f,c,this.options.nodeSize,Float32Array),e&&console.log("z%d: %d clusters in %dms",d,a.length,+Date.now()-l)}return e&&console.timeEnd("total time"),this},getClusters:function(t,e){if(t[0]>t[2]){var o=this.getClusters([t[0],t[1],180,t[3]],e),n=this.getClusters([-180,t[1],t[2],t[3]],e);return o.concat(n)}for(var r=this.trees[this._limitZoom(e)],i=r.range(u(t[0]),p(t[3]),u(t[2]),p(t[1])),a=[],h=0;h<i.length;h++){var f=r.points[i[h]];a.push(f.numPoints?s(f):this.points[f.id])}return a},getChildren:function(t){var e=t>>5,o=t%32,n="No cluster with the specified id.",r=this.trees[o];if(!r)throw new Error(n);var i=r.points[e];if(!i)throw new Error(n);for(var a=this.options.radius/(this.options.extent*Math.pow(2,o-1)),u=r.within(i.x,i.y,a),p=[],h=0;h<u.length;h++){var f=r.points[u[h]];f.parentId===t&&p.push(f.numPoints?s(f):this.points[f.id])}if(0===p.length)throw new Error(n);return p},getLeaves:function(t,e,o){e=e||10,o=o||0;var n=[];return this._appendLeaves(n,t,e,o,0),n},getTile:function(t,e,o){var n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),i=this.options.extent,s=this.options.radius/i,a=(o-s)/r,u=(o+1+s)/r,p={features:[]};return this._addTileFeatures(n.range((e-s)/r,a,(e+1+s)/r,u),n.points,e,o,r,p),0===e&&this._addTileFeatures(n.range(1-s/r,a,1,u),n.points,r,o,r,p),e===r-1&&this._addTileFeatures(n.range(0,a,s/r,u),n.points,-1,o,r,p),p.features.length?p:null},getClusterExpansionZoom:function(t){for(var e=t%32-1;e<this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e},_appendLeaves:function(t,e,o,n,r){for(var i=this.getChildren(e),s=0;s<i.length;s++){var a=i[s].properties;if(a&&a.cluster?r+a.point_count<=n?r+=a.point_count:r=this._appendLeaves(t,a.cluster_id,o,n,r):r<n?r++:t.push(i[s]),t.length===o)break}return r},_addTileFeatures:function(t,e,o,n,r,i){for(var s=0;s<t.length;s++){var u=e[t[s]];i.features.push({type:1,geometry:[[Math.round(this.options.extent*(u.x*r-o)),Math.round(this.options.extent*(u.y*r-n))]],tags:u.numPoints?a(u):this.points[u.id].properties})}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,e){for(var o=[],n=this.options.radius/(this.options.extent*Math.pow(2,e)),r=0;r<t.length;r++){var i=t[r];if(!(i.zoom<=e)){i.zoom=e;var s=this.trees[e+1],a=s.within(i.x,i.y,n),u=i.numPoints||1,p=i.x*u,h=i.y*u,f=null;this.options.reduce&&(f=this.options.initial(),this._accumulate(f,i));for(var c=(r<<5)+(e+1),d=0;d<a.length;d++){var l=s.points[a[d]];if(!(l.zoom<=e)){l.zoom=e;var m=l.numPoints||1;p+=l.x*m,h+=l.y*m,u+=m,l.parentId=c,this.options.reduce&&this._accumulate(f,l)}}1===u?o.push(i):(i.parentId=c,o.push({x:p/u,y:h/u,zoom:1/0,id:c,parentId:-1,numPoints:u,properties:f}))}}return o},_accumulate:function(t,e){var o=e.numPoints?e.properties:this.options.map(this.points[e.id].properties);this.options.reduce(t,o)}}},{kdbush:2}],2:[function(t,e,o){"use strict";var n=t("./sort"),r=t("./range"),i=t("./within");function s(t,e,o,r,i){e=e||a,o=o||u,i=i||Array,this.nodeSize=r||64,this.points=t,this.ids=new i(t.length),this.coords=new i(2*t.length);for(var s=0;s<t.length;s++)this.ids[s]=s,this.coords[2*s]=e(t[s]),this.coords[2*s+1]=o(t[s]);n(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function a(t){return t[0]}function u(t){return t[1]}e.exports=function(t,e,o,n,r){return new s(t,e,o,n,r)},s.prototype={range:function(t,e,o,n){return r(this.ids,this.coords,t,e,o,n,this.nodeSize)},within:function(t,e,o){return i(this.ids,this.coords,t,e,o,this.nodeSize)}}},{"./range":3,"./sort":4,"./within":5}],3:[function(t,e,o){"use strict";e.exports=function(t,e,o,n,r,i,s){var a,u,p=[0,t.length-1,0],h=[];for(;p.length;){var f=p.pop(),c=p.pop(),d=p.pop();if(c-d<=s)for(var l=d;l<=c;l++)a=e[2*l],u=e[2*l+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[l]);else{var m=Math.floor((d+c)/2);a=e[2*m],u=e[2*m+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[m]);var v=(f+1)%2;(0===f?o<=a:n<=u)&&(p.push(d),p.push(m-1),p.push(v)),(0===f?r>=a:i>=u)&&(p.push(m+1),p.push(c),p.push(v))}}return h}},{}],4:[function(t,e,o){"use strict";function n(t,e,o,n){r(t,o,n),r(e,2*o,2*n),r(e,2*o+1,2*n+1)}function r(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}e.exports=function t(e,o,r,i,s,a){if(s-i<=r)return;var u=Math.floor((i+s)/2);!function t(e,o,r,i,s,a){for(;s>i;){if(s-i>600){var u=s-i+1,p=r-i+1,h=Math.log(u),f=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*f*(u-f)/u)*(p-u/2<0?-1:1),d=Math.max(i,Math.floor(r-p*f/u+c)),l=Math.min(s,Math.floor(r+(u-p)*f/u+c));t(e,o,r,d,l,a)}var m=o[2*r+a],v=i,g=s;for(n(e,o,i,r),o[2*s+a]>m&&n(e,o,i,s);v<g;){for(n(e,o,v,g),v++,g--;o[2*v+a]<m;)v++;for(;o[2*g+a]>m;)g--}o[2*i+a]===m?n(e,o,i,g):n(e,o,++g,s),g<=r&&(i=g+1),r<=g&&(s=g-1)}}(e,o,u,i,s,a%2);t(e,o,r,i,u-1,a+1);t(e,o,r,u+1,s,a+1)}},{}],5:[function(t,e,o){"use strict";function n(t,e,o,n){var r=t-o,i=e-n;return r*r+i*i}e.exports=function(t,e,o,r,i,s){var a=[0,t.length-1,0],u=[],p=i*i;for(;a.length;){var h=a.pop(),f=a.pop(),c=a.pop();if(f-c<=s)for(var d=c;d<=f;d++)n(e[2*d],e[2*d+1],o,r)<=p&&u.push(t[d]);else{var l=Math.floor((c+f)/2),m=e[2*l],v=e[2*l+1];n(m,v,o,r)<=p&&u.push(t[l]);var g=(h+1)%2;(0===h?o-i<=m:r-i<=v)&&(a.push(c),a.push(l-1),a.push(g)),(0===h?o+i>=m:r+i>=v)&&(a.push(l+1),a.push(f),a.push(g))}}return u}},{}]},{},[1])(1)});var features=[],defaultopts={log:!1,radius:60,extent:256,maxZoom:23,minZoom:0,nodeSize:64,initial:function(t){return{}},map:function(t){return t.point_count=1,t.point_count_abbreviated="1",t},reduce:function(t,e){}};function loadFeatures(){index&&(index.load(features),postMessage({indexReady:!0}))}function addFeatures(t,e){self.features="esri"==e?self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}).map(esriToGeoJSON)):"coords"==e?self.features.concat(t.filter(function(t){return validGeom(t,e)}).map(coordToGeoJSON)):self.features.concat((t.features||t).filter(function(t){return validGeom(t,e)}))}function validGeom(t,e){return!!t&&("coords"==e?t.length>=2&&t[0]&&t[1]:"esri"==e?t.geometry&&t.geometry.x&&t.geometry.y:t&&t.geometry&&t.geometry.coordinates&&t.geometry.coordinates.length>=2&&t.geometry.coordinates[0]&&t.geometry.coordinates[1])}function esriToGeoJSON(t){try{var e={type:"Feature",geometry:{type:"Point",coordinates:[t.geometry.x,t.geometry.y]},properties:t.attributes};return e.properties.point_count=1,e.properties.point_count_abbreviated="1",e}catch(e){console.log("Error converting feature to GeoJSON:",t,e)}}function coordToGeoJSON(t,e){try{return{type:"Feature",geometry:{type:"Point",coordinates:t},properties:{objectid:e+1,point_count:1,point_count_abbreviated:"1"}}}catch(t){console.log("Error converting feature to GeoJSON:",feature,t)}}function getJSON(t,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="json",o.setRequestHeader("Accept","application/json"),o.onload=function(){4===o.readyState&&o.status>=200&&o.status<300&&o.response&&e(o.response)},o.send()}self.onmessage=function(t){if(t.data.supercluster)importScripts(t.data.supercluster),postMessage({superclusterReady:!0});else if(t.data&&t.data.bbox&&t.data.zoom)postMessage(self.index.getClusters(t.data.bbox,t.data.zoom));else if(t.data.opts){var e={};for(var o in defaultopts)e[o]=defaultopts[o];for(var o in t.data.opts)e[o]=t.data.opts[o];e.functions&&(importScripts(e.functions),functions.initial&&(e.initial=functions.initial),functions.map&&(e.map=functions.map),functions.reduce&&(e.reduce=functions.reduce)),index=supercluster(e)}else t.data.clear?(features=[],loadFeatures()):t.data.features?(addFeatures(t.data.features,t.data.type),t.data.load&&loadFeatures()):t.data.url&&getJSON(t.data.url,function(e){addFeatures(e,t.data.type||"geojson"),loadFeatures()})},self.supercluster?postMessage({superclusterReady:!0}):postMessage({workerReady:!0});
//# sourceMappingURL=ClusterWorker.js.map